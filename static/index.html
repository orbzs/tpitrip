<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Taipei-day-trip</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <div class="nav">
        <div class="nav__title">台北一日遊</div>
        <div class="nav__login">
          <a href="#">預定行程</a>
          <a class="links__link medium" href="#" id="login">登入/註冊</a>
        </div>
      </div>
      <div class="searchsec--bg">
        <div class="searchsec">
          <div class="searchsec__title">輕鬆享受台北一日悠閒</div>
          <div class="searchsec__caption">
            探索每個角落，體驗城市的深度旅遊行程
          </div>
          <form class="searchsec__searchform" action="">
            <div class="searchform__dropdown" id="select">
              <p>全部分類 ▼</p>
              <ul class="dropdown__ul" id="catlist">
                <li class="ul__cat">全部分類</li>
                <li class="ul__cat">其　　他</li>
                <li class="ul__cat">單車遊蹤</li>
                <li class="ul__cat">宗教信仰</li>
                <li class="ul__cat">戶外踏青</li>
                <li class="ul__cat">歷史建築</li>
                <li class="ul__cat">藍色公路</li>
                <li class="ul__cat">藝文館所</li>
                <li class="ul__cat">親子共遊</li>
                <li class="ul__cat">養生溫泉</li>
              </ul>
            </div>
            <input
              class="searchform__input"
              type="text"
              placeholder="輸入景點名稱查詢"
              name="keyword"
            />
            <button class="searchform__button" type="submit"></button>
          </form>
        </div>
      </div>
    </header>
    <main>
      <div class="mrtlist">
        <button class="mrtlist__L"></button>
        <div class="mrtlist__mrts" id="mrtlist__mrts"></div>
        <button class="mrtlist__R"></button>
      </div>
      <div class="results" id="results"></div>
      <div id="scroll-anchor"></div>
    </main>
    <footer>COPYRIGHT © 2021 台北一日遊</footer>
    <div class="signin">
      <div class="signin__decbar"></div>
      <div class="signin__box">
        <div class="signin__title bold">登入會員帳號</div>
        <div class="signin__closeBtn"></div>
        <form action="" class="signin__form">
          <input
            class="form__input"
            type="text"
            placeholder="輸入電子信箱"
            name="in_email"
          />
          <input
            class="form__input"
            type="password"
            placeholder="輸入密碼"
            name="in_pw"
          />
          <button class="button" type="submit">登入帳戶</button>
        </form>
        <div>
          <a href="" class="signin__tosignup" id="toSignup"
            >還沒有帳戶？點此註冊</a
          >
        </div>
      </div>
    </div>
    <div class="signup">
      <div class="signup__decbar"></div>
      <div class="signup__box">
        <div class="signup__title bold">註冊會員帳號</div>
        <div class="signup__closeBtn"></div>
        <form action="" class="signup__form">
          <input
            class="form__input"
            type="text"
            placeholder="輸入姓名"
            name="up_name"
          />
          <input
            class="form__input"
            type="text"
            placeholder="輸入電子郵件"
            name="up_email"
          />
          <input
            class="form__input"
            type="password"
            placeholder="輸入密碼"
            name="up_pw"
          />
          <button class="button" type="submit">註冊新帳戶</button>
        </form>
        <div>
          <a href="" class="signup__tosignin" id="toSignin"
            >已經有帳戶了？點此登入</a
          >
        </div>
      </div>
    </div>
    <div class="overlay" id="overlay"></div>

    <script>
      const select = document.getElementById("select");
      const catlist = document.getElementById("catlist");

      select.addEventListener("click", function (e) {
        e.stopPropagation();
        catlist.classList.toggle("open");
      });

      document.addEventListener("click", function () {
        catlist.classList.remove("open");
      });
    </script>
    <script>
      async function loadCategories() {
        try {
          const res = await fetch("/api/categories");
          const data = await res.json();

          catListEl.innerHTML = "";

          const allLi = document.createElement("li");
          allLi.className = "ul__cat";
          allLi.textContent = "全部分類";
          catListEl.appendChild(allLi);

          const categories = (data.data || []).filter(
            (c) => typeof c === "string" && c.trim().length
          );

          categories.forEach((c) => {
            const li = document.createElement("li");
            li.className = "ul__cat";
            li.textContent = c;
            catListEl.appendChild(li);
          });
        } catch (err) {
          console.error("載入分類失敗", err);
        }
      }
      loadCategories();
    </script>
    <script>
      //
      const state = {
        nextPage: 0,
        isLoading: false,
        isEnd: false,
        category: null,
        keyword: null,
      };

      const resultsEl = document.getElementById("results");

      //
      function renderAttractions(list) {
        list.forEach((item) => {
          const attractionLinkEl = document.createElement("a");
          attractionLinkEl.className = "results__attraction";
          attractionLinkEl.href = `/attraction/${item.id}`; // Part 3-4
          attractionLinkEl.setAttribute("aria-label", item.name);

          const bgEl = document.createElement("div");
          bgEl.className = "attraction__bg";
          bgEl.style.backgroundImage = `url(${item.images?.[0] || ""})`;

          const nameEl = document.createElement("p");
          nameEl.className = "attraction__bg__name";
          nameEl.textContent = item.name;

          bgEl.appendChild(nameEl);

          const detailsEl = document.createElement("div");
          detailsEl.className = "attraction__details";

          const mrtEl = document.createElement("p");
          mrtEl.className = "attraction__details__mrt";
          mrtEl.textContent = item.mrt ?? "";

          const categoryEl = document.createElement("p");
          categoryEl.className = "attraction__details__category";
          categoryEl.textContent = item.category;

          detailsEl.appendChild(mrtEl);
          detailsEl.appendChild(categoryEl);

          attractionLinkEl.appendChild(bgEl);
          attractionLinkEl.appendChild(detailsEl);

          resultsEl.appendChild(attractionLinkEl);
        });
      }

      function renderNoResultMessage() {
        const msg = document.createElement("div");
        msg.className = "results__empty";
        msg.textContent = "查無符合條件的景點";

        resultsEl.appendChild(msg);
      }

      //
      async function loadAttractions(reset = false) {
        if (reset) {
          state.nextPage = 0;
          state.isEnd = false;
          resultsEl.innerHTML = "";
        }

        if (state.isLoading || state.isEnd) return;

        state.isLoading = true;

        try {
          const params = new URLSearchParams();
          params.append("page", state.nextPage);
          if (state.category) params.append("category", state.category);
          if (state.keyword) params.append("keyword", state.keyword);

          const res = await fetch(`/api/attractions?${params.toString()}`);
          const data = await res.json();

          if (reset && (!data.data || data.data.length === 0)) {
            renderNoResultMessage();
            state.isEnd = true;
            return;
          }

          renderAttractions(data.data);

          if (data.nextPage === null) {
            state.isEnd = true;
          } else {
            state.nextPage = data.nextPage;
          }

          requestAnimationFrame(() => {
            if (!state.isEnd && isInViewport(anchor, 300)) {
              loadAttractions(false);
            }
          });
        } catch (err) {
          console.error("載入景點失敗", err);
        } finally {
          state.isLoading = false;
        }
      }

      //
      const anchor = document.getElementById("scroll-anchor");

      function isInViewport(el, margin = 300) {
        const rect = el.getBoundingClientRect();
        return rect.top < window.innerHeight + margin && rect.bottom > 0;
      }

      const observer = new IntersectionObserver(
        (entries) => {
          if (entries[0].isIntersecting) {
            loadAttractions();
          }
        },
        { rootMargin: "300px" }
      );

      observer.observe(anchor);

      //
      loadAttractions(true);

      //
      const catListEl = document.getElementById("catlist");
      const dropdownTitle = document.querySelector("#select p");

      catListEl.addEventListener("click", (e) => {
        if (!e.target.classList.contains("ul__cat")) return;

        const selected = e.target.textContent.trim();

        dropdownTitle.textContent = `${selected} ▼`;

        state.category = selected === "全部分類" ? null : selected;

        catListEl.classList.remove("open");
      });

      //
      const searchForm = document.querySelector(".searchsec__searchform");
      const keywordInput = document.querySelector(".searchform__input");

      searchForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const kw = keywordInput.value.trim();

        state.keyword = kw.length ? kw : null;

        loadAttractions(true);
      });

      //
      const mrtContainer = document.getElementById("mrtlist__mrts");

      async function loadMrts() {
        try {
          const res = await fetch("/api/mrts");
          const data = await res.json();

          mrtContainer.innerHTML = "";

          const mrts = (data.data || []).filter(
            (name) => typeof name === "string" && name.trim().length
          );

          mrts.forEach((name) => {
            const mrtEl = document.createElement("div");
            mrtEl.className = "mrtlist__mrts__m";
            mrtEl.textContent = name;
            mrtContainer.appendChild(mrtEl);
          });
        } catch (err) {
          console.error("載入 MRT 失敗", err);
        }
      }

      mrtContainer.addEventListener("click", (e) => {
        const target = e.target;
        if (!target.classList.contains("mrtlist__mrts__m")) return;

        const mrtName = target.textContent.trim();

        keywordInput.value = mrtName;

        state.keyword = mrtName.length ? mrtName : null;

        loadAttractions(true);
      });

      loadMrts();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const mrtContainer = document.getElementById("mrtlist__mrts");
        const btnLeft = document.querySelector(".mrtlist__L");
        const btnRight = document.querySelector(".mrtlist__R");

        if (!mrtContainer || !btnLeft || !btnRight) return;

        const getStep = () =>
          Math.max(200, Math.floor(mrtContainer.clientWidth * 0.8));

        btnLeft.addEventListener("click", () => {
          mrtContainer.scrollBy({ left: -getStep(), behavior: "smooth" });
        });

        btnRight.addEventListener("click", () => {
          mrtContainer.scrollBy({ left: getStep(), behavior: "smooth" });
        });

        initAuthDialog();
        initAuthStatus();
      });
    </script>
    <script>
      // Part 4-3: User Sign-In Status Checking Procedure
      async function initAuthStatus() {
        const loginBtn = document.querySelector("#login");
        if (!loginBtn) return;

        const token = localStorage.getItem("token");

        if (!token) {
          loginBtn.textContent = "登入/註冊";
          return;
        }

        try {
          const res = await fetch("/api/user/auth", {
            method: "GET",
            headers: {
              Accept: "application/json",
              Authorization: `Bearer ${token}`,
            },
          });

          const result = await res.json();

          if (!res.ok || !result || result.data === null) {
            localStorage.removeItem("token");
            loginBtn.textContent = "登入/註冊";
            return;
          }

          loginBtn.textContent = "登出系統";

          const newBtn = loginBtn.cloneNode(true);
          loginBtn.parentNode.replaceChild(newBtn, loginBtn);

          newBtn.addEventListener("click", (e) => {
            e.preventDefault();
            signOut();
          });
        } catch (err) {
          console.error("Auth status check failed:", err);
          localStorage.removeItem("token");
          loginBtn.textContent = "登入/註冊";
        }
      }

      function signOut() {
        localStorage.removeItem("token");
        location.reload();
      }
    </script>
    <script>
      // Part 4-2: Pop-Up Dialog for User Sign Up/In

      function initAuthDialog() {
        const loginBtn = document.querySelector("#login");

        const signin = document.querySelector(".signin");
        const signup = document.querySelector(".signup");
        const overlay = document.querySelector(".overlay");

        const closeSignin = document.querySelector(".signin__closeBtn");
        const closeSignup = document.querySelector(".signup__closeBtn");

        const toSignup = document.querySelector("#toSignup");
        const toSignin = document.querySelector("#toSignin");

        if (!loginBtn || !signin || !signup) return;

        const openOverlay = () => overlay.classList.add("is-open");
        const closeOverlay = () => overlay.classList.remove("is-open");

        const openSignin = () => {
          clearAuthMsg();
          signin.classList.add("is-open");
          signup.classList.remove("is-open");
          openOverlay();
        };

        const openSignup = () => {
          clearAuthMsg();
          signup.classList.add("is-open");
          signin.classList.remove("is-open");
          openOverlay();
        };

        const closeAll = () => {
          clearAuthMsg();
          signin.classList.remove("is-open");
          signup.classList.remove("is-open");
          closeOverlay();
        };

        loginBtn.addEventListener("click", (e) => {
          e.preventDefault();
          openSignin();
          openOverlay();
        });

        if (closeSignin) closeSignin.addEventListener("click", closeAll);
        if (closeSignup) closeSignup.addEventListener("click", closeAll);
        overlay.addEventListener("click", closeAll);

        if (toSignup) {
          toSignup.addEventListener("click", (e) => {
            e.preventDefault();
            openSignup();
          });
        }

        if (toSignin) {
          toSignin.addEventListener("click", (e) => {
            e.preventDefault();
            openSignin();
          });
        }
      }

      function clearAuthMsg() {
        const oldMsgs = document.querySelectorAll(".authmsg");
        oldMsgs.forEach((el) => el.remove());
      }

      function showAuthMsg(target, msg) {
        clearAuthMsg();

        const box =
          target === "signin"
            ? document.querySelector(".signin__box")
            : document.querySelector(".signup__box");

        if (!box) return;

        const msgDiv = document.createElement("div");
        msgDiv.className = "authmsg";
        msgDiv.textContent = msg;

        const form = box.querySelector("form");
        if (form && form.nextSibling) {
          box.insertBefore(msgDiv, form.nextSibling);
        } else {
          box.appendChild(msgDiv);
        }
      }
    </script>
    <script>
      //Part 4-4: Sign Up Procedure
      const signupForm = document.querySelector(".signup__form");

      if (signupForm) {
        signupForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearAuthMsg();

          const name = signupForm.up_name.value.trim();
          const email = signupForm.up_email.value.trim();
          const password = signupForm.up_pw.value.trim();

          try {
            const res = await fetch("/api/user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, email, password }),
            });

            const result = await res.json();

            if (res.ok && result.ok) {
              showAuthMsg("signup", "註冊成功");
            } else {
              showAuthMsg("signup", result.message || "註冊失敗");
            }
          } catch {
            showAuthMsg("signup", "系統錯誤，請稍後再試");
          }
        });
      }

      //Part 4-5: Sign In Procedure
      const signinForm = document.querySelector(".signin__form");

      if (signinForm) {
        signinForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clearAuthMsg();

          const email = signinForm.in_email.value.trim();
          const password = signinForm.in_pw.value.trim();

          try {
            const res = await fetch("/api/user/auth", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });

            const result = await res.json();

            if (res.ok && result.token) {
              localStorage.setItem("token", result.token);
              location.reload();
            } else {
              showAuthMsg("signin", result.message || "登入失敗");
            }
          } catch {
            showAuthMsg("signin", "系統錯誤，請稍後再試");
          }
        });
      }
    </script>
  </body>
</html>
